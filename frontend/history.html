<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>History ‚Äî AK Shortener</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
        .page-hero {
            padding: 3rem 0 1.5rem;
        }

        .page-hero h1 {
            font-size: 2.2rem;
            font-weight: 900;
        }

        .toolbar {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .toolbar .form-input {
            max-width: 260px;
        }

        .url-dest {
            max-width: 240px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ttl-bar-wrap {
            width: 80px;
            height: 6px;
            background: var(--surface2);
            border-radius: 3px;
            overflow: hidden;
        }

        .ttl-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }

        .action-btns {
            display: flex;
            gap: 0.4rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="nav-logo">‚ö° AK Shortener</a>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="shorten.html">Shorten</a>
            <a href="analytics.html">Analytics</a>
            <a href="history.html" class="active">History</a>
        </div>
    </nav>

    <div class="container">
        <div class="page-hero fade-up"
            style="display:flex;justify-content:space-between;align-items:flex-end;flex-wrap:wrap;gap:1rem;">
            <div>
                <h1>URL History</h1>
                <p class="text-muted mt-1">All your shortened links ‚Äî search, view QR, or delete.</p>
            </div>
            <button class="btn btn-outline" style="color:var(--danger);border-color:var(--danger);"
                onclick="clearAll()">üóë Clear All</button>
        </div>

        <div class="toolbar fade-up delay-1">
            <input id="searchInput" type="text" class="form-input" placeholder="üîç Search by code or URL‚Ä¶"
                oninput="renderTable()" />
            <select id="filterStatus" class="form-input" style="max-width:150px;" onchange="renderTable()">
                <option value="all">All URLs</option>
                <option value="active">Active only</option>
                <option value="expired">Expired only</option>
            </select>
            <select id="sortBy" class="form-input" style="max-width:150px;" onchange="renderTable()">
                <option value="newest">Newest first</option>
                <option value="oldest">Oldest first</option>
                <option value="clicks">Most clicks</option>
            </select>
            <span class="text-muted text-sm" id="countLabel"></span>
        </div>

        <div class="card fade-up delay-2" style="padding:0;">
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Short Code</th>
                            <th>Destination</th>
                            <th>Clicks</th>
                            <th>Status</th>
                            <th>TTL</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        <tr>
                            <td colspan="7" style="text-align:center;color:var(--text-muted);padding:2rem;">Loading‚Ä¶
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="modal-overlay" id="qrModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üì± QR Code</div>
                <button class="modal-close" onclick="closeQR()">‚úï</button>
            </div>
            <div style="text-align:center;">
                <canvas id="qrCanvas" width="220" height="220" style="border-radius:8px;background:#fff;"></canvas>
                <div class="mt-2 text-sm text-muted" id="qrLabel"></div>
                <div class="mt-2" style="display:flex;gap:0.6rem;justify-content:center;">
                    <button class="btn btn-primary btn-sm" onclick="downloadQR()">‚¨á Download</button>
                    <button class="btn btn-outline btn-sm" onclick="copyQRUrl()">üìã Copy URL</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"></div>
    <script>
        let allUrls = [], currentQRCode = '', currentQRUrl = '';

        async function loadUrls() {
            try {
                const r = await fetch('/api/urls');
                allUrls = await r.json();
                renderTable();
            } catch {
                document.getElementById('historyTable').innerHTML =
                    `<tr><td colspan="7" style="text-align:center;color:var(--danger);padding:2rem;">‚ö†Ô∏è Cannot reach server. Is it running on port 3000?</td></tr>`;
            }
        }

        function renderTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('filterStatus').value;
            const sort = document.getElementById('sortBy').value;

            let filtered = allUrls.filter(u => {
                const matchSearch = u.shortCode.toLowerCase().includes(search) || u.longUrl.toLowerCase().includes(search);
                const matchFilter = filter === 'all' || (filter === 'active' && !u.expired) || (filter === 'expired' && u.expired);
                return matchSearch && matchFilter;
            });

            if (sort === 'newest') filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            else if (sort === 'oldest') filtered.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            else if (sort === 'clicks') filtered.sort((a, b) => b.clicks - a.clicks);

            document.getElementById('countLabel').textContent = `${filtered.length} link${filtered.length !== 1 ? 's' : ''}`;

            const tbody = document.getElementById('historyTable');
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="icon">üì≠</div><p>No links found. <a href="shorten.html" style="color:var(--primary-l)">Shorten a URL</a> to get started.</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(u => {
                const status = u.expired
                    ? `<span class="badge badge-danger">Expired</span>`
                    : `<span class="badge badge-success">Active</span>`;

                let ttlHtml = '<span class="text-muted text-sm">‚Äî</span>';
                if (u.expiresAt) {
                    const now = Date.now();
                    const expiresMs = new Date(u.expiresAt).getTime();
                    const createdMs = new Date(u.createdAt).getTime();
                    const total = expiresMs - createdMs;
                    const remaining = Math.max(0, expiresMs - now);
                    const pct = u.expired ? 0 : Math.round((remaining / total) * 100);
                    const color = pct > 50 ? 'var(--success)' : pct > 20 ? 'var(--warning)' : 'var(--danger)';
                    const label = u.expired ? 'Expired'
                        : remaining < 3600000 ? `${Math.round(remaining / 60000)}m`
                            : remaining < 86400000 ? `${Math.round(remaining / 3600000)}h`
                                : `${Math.round(remaining / 86400000)}d`;
                    ttlHtml = `<div style="display:flex;align-items:center;gap:0.4rem;">
          <div class="ttl-bar-wrap"><div class="ttl-bar" style="width:${pct}%;background:${color};"></div></div>
          <span class="text-sm" style="color:${color};">${label}</span>
        </div>`;
                }

                const dest = u.longUrl.length > 32 ? u.longUrl.slice(0, 32) + '‚Ä¶' : u.longUrl;
                const created = new Date(u.createdAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                const shortUrl = `http://localhost:3000/${u.shortCode}`;

                return `<tr>
        <td><code style="color:var(--accent-l);font-size:0.95rem;">/${u.shortCode}</code></td>
        <td class="url-dest"><a href="${u.longUrl}" target="_blank" style="color:var(--text-muted);text-decoration:none;" title="${u.longUrl}">${dest}</a></td>
        <td><strong>${u.clicks}</strong></td>
        <td>${status}</td>
        <td>${ttlHtml}</td>
        <td class="text-muted text-sm">${created}</td>
        <td><div class="action-btns">
          <button class="btn btn-sm btn-outline" title="Copy" onclick="copyLink('${shortUrl}')">üìã</button>
          <button class="btn btn-sm btn-outline" title="QR Code" onclick="showQR('${u.shortCode}','${shortUrl}')">üì±</button>
          <button class="btn btn-sm btn-outline" title="Delete" style="color:var(--danger);border-color:rgba(239,68,68,0.3);" onclick="deleteUrl('${u.shortCode}')">üóë</button>
        </div></td>
      </tr>`;
            }).join('');
        }

        function copyLink(url) {
            navigator.clipboard.writeText(url);
            showToast('‚úÖ Copied!', 'success');
        }

        async function deleteUrl(code) {
            try {
                await fetch(`/api/urls/${code}`, { method: 'DELETE' });
                showToast('üóë Deleted', '');
                loadUrls();
            } catch { showToast('Error deleting', 'error'); }
        }

        async function clearAll() {
            if (!confirm('Delete all URLs? This cannot be undone.')) return;
            try {
                await fetch('/api/urls', { method: 'DELETE' });
                showToast('All URLs cleared', '');
                loadUrls();
            } catch { showToast('Error', 'error'); }
        }

        function showQR(code, url) {
            currentQRCode = code; currentQRUrl = url;
            document.getElementById('qrLabel').textContent = url;
            document.getElementById('qrModal').classList.add('open');
            drawQR(url);
        }
        function closeQR() { document.getElementById('qrModal').classList.remove('open'); }
        function copyQRUrl() { navigator.clipboard.writeText(currentQRUrl); showToast('‚úÖ Copied!', 'success'); }
        function downloadQR() {
            const a = document.createElement('a');
            a.download = `qr-${currentQRCode}.png`;
            a.href = document.getElementById('qrCanvas').toDataURL();
            a.click();
        }

        function drawQR(text) {
            const canvas = document.getElementById('qrCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, 220, 220);
            const cells = 21, cell = Math.floor(220 / cells);
            let seed = 0; for (let i = 0; i < text.length; i++) seed += text.charCodeAt(i);
            function rand(i, j) { const v = Math.sin(seed + i * 31 + j * 17) * 10000; return v - Math.floor(v) > 0.45; }
            for (let r = 0; r < cells; r++) {
                for (let c = 0; c < cells; c++) {
                    const inFinder = (r < 8 && c < 8) || (r < 8 && c >= cells - 8) || (r >= cells - 8 && c < 8);
                    if (inFinder) { const fr = r % 8, fc = c % 8; if (fr === 0 || fr === 6 || fc === 0 || fc === 6 || (fr >= 2 && fr <= 4 && fc >= 2 && fc <= 4)) { ctx.fillStyle = '#1a1a2e'; ctx.fillRect(c * cell, r * cell, cell - 1, cell - 1); } }
                    else if (rand(r, c)) { ctx.fillStyle = '#1a1a2e'; ctx.fillRect(c * cell, r * cell, cell - 1, cell - 1); }
                }
            }
        }

        function showToast(msg, type = '') {
            const t = document.getElementById('toast'); t.textContent = msg; t.className = 'show ' + type;
            setTimeout(() => t.className = '', 2800);
        }

        loadUrls();
        setInterval(loadUrls, 5000);
    </script>
</body>

</html>